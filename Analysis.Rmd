---
title             : "National Longitudinal Evidence for Growth in Well-being From Spiritual Beliefs"
shorttitle        : "Title"
author: 
  - name          : "Ben Highland"
    affiliation   : "1"
    corresponding : yes    # Define only one corresponding author
    address       : "Postal address"
    email         : "my@email.com"
    role:         # First author
      - Conceptualization
      - Writing - Original Draft Preparation
      - Writing - Review & editing
  - name          : "Joseph Bulbulia"
    affiliation   : "1,2"
    role:
      - Writing - 
      - Analysis 
affiliation:
  - id            : "1"
    institution   : "Wake Forest Med School "
  - id            : "2"
    institution   : "Victoria University"
authornote: |
  Add complete departmental affiliations for each author here. Each new line herein must be indented, like this line.
  Enter author note here.
abstract: |
 A growing body of research finds an association between spirituality and subjective well-being. However, the use of tautological scales and a reliance on cross-sectional data compromise inference. Here, drawing on nine years of panel responses from a nationally diverse longitudinal study. We systematically test whether having spiritual beliefs improves subjective well-being (N = 21,705, New Zealand, 2010-2018). Supporting previous studies, we observe that belief in a spirit or life force predicts increasing life satisfaction over time. However, we also observe that relative to the disbelieving population, belief in a spirit or life force is initially associated with lower personal well-being. Such effects, which hold, after adjusting for known demographic and personal influences on subjective well-being, are consistent with findings that spiritual beliefs are compelling to those with lower well-being. However, despite the scale and resolution of these longitudinal data, the causal interplay between spiritual beliefs and subjective well-being remain matters for future investigations. 
  
  
  
  <!-- https://tinyurl.com/ybremelq -->
keywords          : "keywords"
wordcount         : "X"
bibliography      : ["r-references.bib"]
floatsintext      : no
figurelist        : no
tablelist         : no
footnotelist      : no
linenumbers       : yes
mask              : no
draft             : no
documentclass     : "apa6"
classoption       : "man"
output            : "html_document" 
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
library("papaja")
r_refs("r-references.bib")
```

```{r global_options, echo=FALSE, include = FALSE}
knitr::opts_chunk$set(fig.path="Figs/", 
                      message=FALSE, 
                      warning=FALSE,
                      collapse =TRUE,
                      echo=TRUE, 
                      #results="hide", 
                      fig.width= 10,
                      fig.height=8,
                      tidy = "styler")
```
```{r load_libraries, echo=FALSE, include=FALSE}
library("styler")
library("tidyverse")
library("lme4")
library("ggplot2")
library("tidyr")
library("ggeffects")
library("Amelia")
library("table1")
library("patchwork")
library("parameters")
library("prettycode")
library("table1")
library("gghighlight")
library("sjPlot")
library("see")
#library("viridis")
#library("ggpubr")
#library("wesanderson")
library("ggsci")
library("papaja")
#library("here")
library("citr")
library("texreg")
```


# Methods
 <!-- 21-word solution (Simmons, Nelson & Simonsohn, 2012; retrieved from http://ssrn.com/abstract=2160588) -->
We used `r cite_r("r-references.bib")` for all our analyses.



Load data (this is sepcific to my machine)
```{r load_data}
ldf.5<-readRDS("~/The\ Virtues\ Project\ Dropbox/Joseph\ Bulbulia/00Bulbulia\ Pubs/2020/ldf.5") 
```

Processing of data.
```{r data processing, cache = TRUE, dependson = "ldf.5"}
# filter only those who are measured 
dfben  <-ldf.5 %>%
  dplyr:: filter(Wave !=2009)%>% # exclude wave 1 (no spirit measures that wave)
  dplyr::filter(YearMeasured==1)%>%
  dplyr::group_by(Id) %>% filter(n() > 2)%>% # select those who have responded to at least 3 waves # Also works for 5 and 7
  dplyr::filter(n() !=0)%>%
  dplyr::ungroup(Id)%>%
  dplyr:: mutate(Years = as.numeric(years))%>%
  dplyr::mutate(Age.10yrs = (Age/10))%>%
  dplyr::mutate(Religion.Church.Log = log(Religion.Church+ 1))%>%
  dplyr::mutate(Pol.Orient.S = scale(Pol.Orient, center = TRUE, scale = TRUE),
         Age.10yrs.C = scale(Age.10yrs, center = TRUE, scale = FALSE),
         Male = factor(Gender),
         Employed = factor(Employed),
         Partner = factor(Partner),
         Edu.S = scale(as.numeric(Edu) ,scale=TRUE,center=TRUE),
         Education = as.numeric(Edu),
         Urban = factor(Urban),
         Believe.Spirit = as.factor(Believe.Spirit),
         Believe.God = as.factor(Believe.God),
         EthnicCategories = factor(EthnicCats),
         LIFESAT.S = scale(LIFESAT, center = TRUE, scale = TRUE),
         PWI.S = scale(PWI, center = TRUE, scale = TRUE),
         Deprivation.S = scale(NZdep, scale=TRUE, center=TRUE),
         Relid.C = scale(Relid, scale = TRUE,center=TRUE),
         Religious = as.factor(Religious),
         Religion.Church.Log.C = scale(Religion.Church.Log, center = TRUE, scale = FALSE))
```
```{r}
# nice labels
table1::label(dfben$Age.10yrs.C) <- "Age in Decades (C)"
table1::label(dfben$PWI) <- "Personal Wellbeing"
table1::label(dfben$LIFESAT) <- "Life Satisfaction"

table1::label(dfben$Deprivation.S) <- "Deprivation (S)"
table1::label(dfben$Pol.Orient) <- "Political Conservative"
table1::label(dfben$Pol.Orient.S) <- "Political Conservative (S)"
table1::label(dfben$NZdep) <- "NZ Deprivation Index"
dfben$Partner <- factor(dfben$Partner, labels = c("No Partner","Has Partner"))
dfben$Employed <- factor(dfben$Employed, labels = c("Not Employed","Employed"))
table1::label(dfben$Edu.S) <- "Education (S)"

# beliefs indicator
dfben$Beliefs<- factor(ifelse(dfben$Believe.God == "Not Believe God" & dfben$Believe.Spirit == "Not Believe Spirit", "_Skeptic_", 
                                        ifelse(dfben$Believe.God == "Not Believe God" & dfben$Believe.Spirit == "Believe Spirit", "_SpiritExcludesGod_",
                                               ifelse(dfben$Believe.God == "Believe God" & dfben$Believe.Spirit == "Believe Spirit","GodAndSpirit","GodExcludesSpirit"))))
```

Table of belief types
```{r}
table(dfben$Beliefs)
```


```{r echo=FALSE}
# nice labels
#dfben$GodSpiritBeliefs <- factor(dfben$GodSpiritBeliefs, labels = c("Skeptic","SpiritExcludesGod","GodAndSpirit","GodExcludesSpirit"))
# check to make sure labels are right
#table(dfben$GodSpiritBeliefs) == table(dfben$GodSpiritBeliefs)
```

There are `r  length(unique(dfben$Id))` participants.

This is the number of times participants returned responses: 
```{r}
dplyr::count(tally(group_by(dfben, Id), sort = TRUE, name="number_waves"),number_waves)
```


Table.

```{r}
table1::table1(~  Age + NZdep + Education + Employed + EthnicCategories + Male  + Partner  + Pol.Orient + Urban +  Beliefs + LIFESAT + PWI|Wave, data = dfben, overall = F)
```


```{r, include =FALSE}
furniture::table1(dfben, Age, NZdep,Education,Employed,EthnicCategories,Male,Partner, Pol.Orient,Urban, Beliefs, LIFESAT,PWI,
                    splitby = ~Wave, overall=F, output = "latex2", booktabs=TRUE)
```


```{r, include=FALSE}
r<-report::report_participants(
  dfben,
  age = "Age",
  sex = "Male",
  education = "Education",
  participants = "Id",
  group = "Wave",
  spell_n = FALSE,
)
```

We demean variables following https://easystats.github.io/parameters/articles/demean.html

```{r}
dfben <- cbind(
  dfben,
  parameters::demean(dfben, select = c("Beliefs"), group = "Id")
)
```


# Results


```{r models, cache = TRUE, dependson = "dfben"}
### Spirit Belief Models ### 
mod01<-lmer (LIFESAT ~ Years *(
                Beliefs__Skeptic__between  +  
                Beliefs__SpiritExcludesGod__between + 
                Beliefs_GodAndSpirit_between  + 
                Beliefs_GodExcludesSpirit_between +
                Beliefs__Skeptic__within  +  
                Beliefs__SpiritExcludesGod__within + 
                Beliefs_GodAndSpirit_within  + 
                Beliefs_GodExcludesSpirit_within) +
                (1|Id), data= dfben, na.action = na.omit)

parameters::check_heterogeneity(mod01, group = "ID")

mod02<-lmer (LIFESAT ~ Years *( 
                Beliefs__Skeptic__between  +  
                Beliefs__SpiritExcludesGod__between + 
                Beliefs_GodAndSpirit_between  + 
                Beliefs_GodExcludesSpirit_between +
                Beliefs__Skeptic__within  +  
                Beliefs__SpiritExcludesGod__within + 
                Beliefs_GodAndSpirit_within  + 
                Beliefs_GodExcludesSpirit_within) +
                (1|Id), data= dfben, na.action = na.omit)

parameters::check_heterogeneity(mod02, group = "ID")

# inference holds, but can we use this method with factors?  In any case, we keep to the simple model
tab_model(mod01)
tab_model(mod02)

# Inference holds 
library(lme4)
mod.1 <-lmer (PWI ~  1 +  Years * Beliefs +  Age.10yrs.C + Deprivation.S + Edu.S  + Employed + EthnicCats + Male  + Partner  + Pol.Orient.S + Urban + (1|Id), data= dfben, na.action = na.omit)
mod.2 <-lmer (LIFESAT ~ 1 + Years * Beliefs+ Age.10yrs.C + Deprivation.S + Edu.S  + Employed + EthnicCats + Male  + Partner  + Pol.Orient.S + Urban + (1|Id), data= dfben, na.action = na.omit)
summary(mod.1)
summary(mod.2)


## Try models with generation as rand effect. Reason: how to interpret differences in intercepts?  # USING glmmTMB because lmer is crashing SAME RESULT SO IGNORE
# mod.1 <-glmmTMB(LIFESAT ~ Years * Beliefs + Deprivation.S + Edu.S  + Employed + EthnicCats + Male  + Partner  + Pol.Orient.S + Urban + (1|Id) + (1|GenCohort), data= dfben)
# 
# mod.2 <-glmmTMB(PWI ~ Years * Beliefs + Deprivation.S + Edu.S  + Employed + EthnicCats + Male  + Partner  + Pol.Orient.S + Urban + (1|Id) + (1|GenCohort), data= dfben)
```



```{r cache = TRUE, dependson="mod.2", dependson="mod.1"}
tab_model(mod.2, mod.1) # Table
```

```{r, echo = FALSE, include=FALSE}
te00 <-texreg::extract(
  mod.1,
  level = 0.95,
  include.random = TRUE,
  include.rsquared = T,
  include.nobs = T,
  include.loo.ic = T,
  include.waic = F)

texreg(list(te00),
                custom.model.names = c("PWI"),
                caption = "Personal Wellbeing",
                sideways = F,
                scalebox = .5,
                #fontsize= "footnotesize",
                label = "tab:REGRESS_1",
                ci.force.level = 0.95, bold = 0.05,
                settingstars = 0,
                booktabs = TRUE,
                custom.note ="")
```



```{r, echo = FALSE, include=FALSE}
te02 <-texreg::extract(
  mod.2,
  level = 0.95,
  include.random = TRUE,
  include.rsquared = T,
  include.nobs = T,
  include.loo.ic = T,
  include.waic = F)

texreg(list(te02),
                custom.model.names = c("PWI"),
                caption = "LifeSatisfaction",
                sideways = F,
                scalebox = .5,
                #fontsize= "footnotesize",
                label = "tab:REGRESS_1",
                ci.force.level = 0.95, bold = 0.05,
                settingstars = 0,
                booktabs = TRUE,
                custom.note ="")
texreg(list(te02),
                custom.model.names = c("PWI"),
                caption = "LifeSatisfaction",
                sideways = F,
                scalebox = .5,
                #fontsize= "footnotesize",
                label = "tab:REGRESS_1",
                ci.force.level = 0.95, bold = 0.05,
                settingstars = 0,
                booktabs = TRUE,
                custom.note ="")

texreg(list(te00, te02), dcolumn = F, booktabs = TRUE, scalebox = .6,ci.force.level = 0.95, bold = 0.05,
                settingstars = 0, caption = "Regression Models")
```

```{r, echo = FALSE, include=FALSE}
te00 <-texreg::extract(
  mod.1,
  level = 0.95,
  include.random = TRUE,
  include.rsquared = T,
  include.nobs = T,
  include.loo.ic = T,
  include.waic = F)
texreg(list(te00),
                custom.model.names = c("PWI"),
                caption = "Personal Wellbeing",
                sideways = F,
                scalebox = .5,
                #fontsize= "footnotesize",
                label = "tab:REGRESS_1",
                ci.force.level = 0.95, bold = 0.05,
                settingstars = 0,
                booktabs = TRUE,
                custom.note ="")
```

Plot models
```{r USEcoefficientplots}
plot_models(mod.2, mod.1) + ylim(-.4, .75) + theme_abyss() + scale_colour_brewer(labels = c("Personal Wellbeing", "Life Satisfaction")) # Plots
```
```{r}
library(parameters)
g1<-plot(parameters::model_parameters(mod.1))+ ggtitle("Personal Wellbeing Coefficients")
g2<-plot(parameters::model_parameters(mod.2))+ ggtitle("Life Satisfaction Coefficients")
```

```{r USE_2_coefficientplots}
g1/g2
```


```{r cache = TRUE, dependson = "mod.1"}
#### Predicted Effects ####
pr.PWI <- ggpredict(model = mod.1, terms = c("Years [0:9]","Beliefs"), 
                    ci.lvl = 0.95,
                    type = "fe",
                    typical = "mean",
                   # condition = c(Euro =1),
                    back.transform = TRUE,
                    ppd = FALSE,
                    interval = "confidence")
p1<-plot(pr.PWI, facets = T) + 
 # scale_y_continuous(limits=c(4.75,5.25) )  + 
  gghighlight()  +  theme_blank()+ 
  ggtitle("Predicted Values of Personal Wellbeing") 

pr.PWI
```
```{r pwi_expected}
```

```{r predictlifesat}
pr.LIFESAT <- ggpredict(model = mod.2, terms = c("Years [0:9]", "Beliefs"),
                        ci.lvl = 0.95,
                        type = "fe",
                        typical = "mean",
                     #   condition = c(Euro =1),
                        back.transform = TRUE,
                        ppd = FALSE,
                        interval = "confidence")
# print expected intervals for the y-hats reported in the conclusion
pr.LIFESAT

p2<-plot(pr.LIFESAT,facets = T) + 
 # scale_y_continuous(limits=c(6.35,6.85) ) + 
  gghighlight() + theme_blank() + 
  ggtitle("Predicted Values of Life Satisfaction") #+   scale_colour_brewer(palette = "Zissou1")
p2
```

## Reporting

### equations
Life satisfaction Model 1 equation

```{r eq1}
library(equatiomatic)
print(extract_eq(mod.1, wrap = TRUE,terms_per_line =3))
```

PWI Model 2 equation
```{r eq2}
library(equatiomatic)
print(extract_eq(mod.2, wrap = TRUE, use_coefs=TRUE,terms_per_line = 3))
```


## report

### Model 1
model 1 report: for publication change all "significants" to "reliable"

short report:
```{r, report1, cache =TRUE, dependson=mod.1,include=FALSE}
report::model_text(mod.1)
```

short report
```{r, cache=TRUE, include=FALSE }
library(report)
r1<- report::report(mod.1)
table_short(r1)
text_short(r1)
```


```{r, cache =TRUE, dependson=mod.1, include=FALSE}
r1<- report::report(mod.1)
report::text_long(r1)
```
short report
```{r, cache =TRUE, dependson=mod.2,include=FALSE}
# Model 2
# For publication change all "significants" to "reliable"

report::model_text(mod.2)
```

short report
```{r,include=FALSE}
r2 <- report::report(mod.2)
report::text_short(r2)
report::table_short(r2)
```

long report
```{r,include=FALSE}
r2<- report::report(mod.2)
report::text_long(r2)
```



Graphs of predictions.

```{r USEPWI_expected}
p1 #+ plot_annotation(title = 'All cases Plot')
```

```{r USElifsat_expected}
p2 #+ plot_annotation(title = 'All cases Plot')
```




## Imputed Analysis


```{r echo = TRUE,  cache = TRUE, dependson = "dfben"}
# Imputed data
prp<- dfben %>% # Remove what we do not need anymore
  dplyr::select(c(Beliefs, Age, Id, Education, NZdep,KESSLER6,LIFESAT,PWI,Pol.Orient,Relid,EthnicCats,Partner,Employed,Male,Urban,Years,Wave))

# total ids = 21,705
length(unique(prp$Id))


#Make dataframes
prp<-as.data.frame(prp)

#Bifurcated imputation - This is presented in the main text
set.seed(1234)
imputed <- amelia(
  prp, #dataset to impute
  m = 10, # number of imputations
  cs= c("Id"),
  ts= c("Years"),
  noms = c("EthnicCats",
           "Urban",
           "Partner",
           "Male",
           "Employed",
           "Beliefs"),
  idvars=c("Wave","PWI","LIFESAT"), # not imputing outcomes
  polytime = 3) #https://stackoverflow.com/questions/56218702/missing-data-warning-r
#saveRDS(imputed,"imputed")
#imputed<- readRDS("imputed")

# center and scale indiators
imputed.2 <- transform.amelia(imputed,
                              Age.10yrs = (Age/10),
                              Pol.Orient.S =scale(Pol.Orient, center=TRUE,scale=TRUE),
                              Employed = factor(Employed),
                              Ethnicity = as.factor(EthnicCats),
                              Urban = factor(Urban),
                              Deprivation.S = scale(NZdep, scale=TRUE, center=TRUE),
                              Edu.S = scale(Education, scale =TRUE,center=TRUE),
                              Male = as.factor(Male),
                              PWI = as.numeric(PWI),
                              LIFESAT = as.numeric(LIFESAT),
                              Beliefs = as.factor(Beliefs),
                              Id =as.factor(Id))
# center an d scale age
imputed3 <- transform.amelia(imputed.2,
                                     Age.10yrs.C = scale(Age.10yrs,scale =FALSE, center=TRUE))
```


```{r cache = TRUE}
# run models iterating over imputed data
m <- 10
models3 <- NULL
for(i in 1:m) {
  models3[[i]] <- lmer(PWI ~ Years * Beliefs + Age.10yrs.C + Deprivation.S + Edu.S  + Employed + EthnicCats + Male  + Partner  + Pol.Orient.S + Urban + (1|Id), data=imputed3$imputations[[i]])
}
```

```{r, cache=TRUE, dependson= models3}
#devtools::install_github("easystats/parameters") Get development version
library(parameters)
mps3 <- lapply(models3, model_parameters)
parameters::pool_parameters(mps3)
mp3<-pool_parameters(mps3)
```


```{r coef_PWI_imputed}
# coeff plot
plot(mp3) + ggtitle("Personal Wellbeing Coefficients (Imputed)") # pick your  own title
```

```{r cache = TRUE, dependson = models3}
## expectation
m<-10
out<-NULL
for(i in 1:m) {
  out[[i]] <- ggpredict(models3[[i]], terms =c("Years [0:9]","Beliefs"))
}

m<-10
plots<-NULL
for(i in 1:m) {
  plots[[i]] <- plot(out[[i]], facets = T)# + scale_y_continuous(limits=c(6.35,6.85) )
}
```
```{r, echo=FALSE}
# Inspect all  # No differences
# plots[[1]]
# plots[[2]]
# plots[[3]]
# plots[[4]]
# plots[[5]]
# plots[[6]]
# plots[[7]]
# plots[[8]]
# plots[[9]]
# plots[[10]]
```
```{r predicted_PWI_impute}
# to highlight differencs
explectationGraphPWI <-plots[[10]] + gghighlight() + ggtitle("Predicted Values of Personal Wellbeing (imputed)")
explectationGraphPWI
```
```{r cache =TRUE}
## life sat models
m <- 10
modelsL3 <- NULL

for(i in 1:m) {
  modelsL3[[i]] <- lmer(LIFESAT ~ Years * Beliefs + Age.10yrs.C + Deprivation.S + Edu.S  + Employed + EthnicCats + Male  + Partner  + Pol.Orient.S + Urban +  (1|Id), data=imputed3$imputations[[i]])
}
```
```{r, cache =TRUE, dependson =  modelsL3}
mpl3 <- lapply(modelsL3, model_parameters)
parameters::pool_parameters(mpl3)
ml3<-pool_parameters(mpl3)
ml3 # table
p13<-plot(ml3)

p13<- p13 +  labs(title ="Coefficients Life Satisafaction (imputed)")
# get estimates for PWI from above
p23 <- plot(mp3) + labs(title ="Coefficients Personal Wellbeing (imputed)")
```

```{r coefficient_plot_both_imputed}
 p23/p13 +  plot_annotation(tag_levels = 'i')
```

```{r, cache =TRUE, dependson = "modelsL3"}
# Expectation plots
m<-10
out2<-NULL
for(i in 1:m) {
  out2[[i]] <- ggpredict(modelsL3[[i]], terms = c("Years [0:9]", "Beliefs"),
                         ci.lvl = 0.95,
                         type = "fe",
                         typical = "mean",
                         #   condition = c(Euro =1),
                         back.transform = TRUE,
                         ppd = FALSE,
                         interval = "confidence")
}

m<-10
plots2<-NULL
for(i in 1:m) {
  plots2[[i]] <- plot(out2[[i]], facets = T) #+ scale_y_continuous(limits=c(4.75,5.25) )
}
```
```{r echo = FALSE}
# Inspect all  # No differences
# plots2[[1]]
# plots2[[2]]
# plots2[[3]]
# plots2[[4]]
# plots2[[5]]
# plots2[[6]]
# plots2[[7]]
# plots2[[8]]
# plots2[[9]]
# plots2[[10]]

library(gghighlight)

# Just using one graph
explectationGraphLS <-plots2[[10]] + gghighlight() + ggtitle("Predicted Values of Life Satisfaction (imputed)")
```


```{r predicted_lifesat_imputed, cache=TRUE}
explectationGraphLS
```
```{r combograph_imputed}
# Combo_Graph
#explectationGraphPWI/explectationGraphLS + plot_annotation(title = "Imputed DataSet")
##
sessionInfo()
```

# Discussion
To be continued.

\newpage

# References

\begingroup
\setlength{\parindent}{-0.5in}
\setlength{\leftskip}{0.5in}

<div id="refs" custom-style="Bibliography"></div>
\endgroup
